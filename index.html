<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Détail du deal</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 0; padding: 2rem; }
      .deal { max-width: 600px; margin: auto; border-radius: 12px; padding: 1rem; box-shadow: 0 4px 20px #0001; }
      img { max-width: 100%; border-radius: 12px; margin-bottom: 1rem; }
      h1 { font-size: 1.5rem; margin: 0.2rem 0; }
      .price { font-weight: bold; color: #008000; font-size: 1.2rem; display: flex; align-items: baseline; gap: .5rem; }
      .old { text-decoration: line-through; color: #888; }
      .badge {
        display: inline-block; padding: .2rem .5rem; border-radius: 999px;
        font-weight: 600; font-size: .85rem; background: #e6f6ee; border: 1px solid #bfe7d3; color: #057a55;
      }
      .row { display: flex; align-items: center; justify-content: space-between; gap: .75rem; margin: .5rem 0; flex-wrap: wrap; }
      .coupon {
        display: inline-flex; align-items: center; gap: .5rem;
        background: #f6f7fb; border: 1px dashed #c9cde3; padding: .4rem .6rem; border-radius: 10px;
      }
      .coupon code { font-weight: 700; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      .btn-copy {
        cursor: pointer; border: 1px solid #c9cde3; background: white; border-radius: 8px;
        padding: .25rem .5rem; font-size: .85rem;
      }
      .btn-copy:active { transform: scale(.98); }
      a.cta { display: inline-block; margin-top: .75rem; text-decoration: none; padding: .6rem .9rem; border-radius: 10px; background: black; color: white; }
    </style>
  </head>
  <body>
    <div id="deal" class="deal">Chargement...</div>

    <script>
      // === Configuration ===
      const SUPABASE_URL = "https://fgwytagsmcjzrbjhcude.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_Qo1qCBUJpKpF5nzOCKFmqw_TrfzU0Hp";

      // === Lecture du paramètre 'token' dans l'URL ===
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");

      if (!token) {
        document.getElementById("deal").textContent = "❌ Aucun token fourni dans l’URL.";
      } else {
        loadDeal(token);
      }

      async function loadDeal(token) {
        try {
          const url = `${SUPABASE_URL}/rest/v1/deals?select=*`;
          const res = await fetch(url, {
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              "x-deal-token": token, // lu dans la policy RLS
            },
          });
          if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
          const data = await res.json();
          if (!data.length) {
            document.getElementById("deal").textContent = "Aucun deal trouvé pour ce token.";
            return;
          }

          const d = data[0];

          // Préparation des affichages
          const priceCurrent = (d.price_current != null) ? `${d.price_current} €` : "";
          const priceOriginal = (d.price_original != null) ? `${d.price_original} €` : "";
          const discount = (d.prct_discount != null) ? `-${d.prct_discount}%` : "";
          const couponHTML = d.coupon_code
            ? `
              <div class="coupon">
                <span>Code&nbsp;promo:</span>
                <code id="coupon-code">${escapeHtml(d.coupon_code)}</code>
                <button class="btn-copy" onclick="copyCoupon()">Copier</button>
              </div>
            `
            : "";

          document.getElementById("deal").innerHTML = `
            ${d.image ? `<img src="${escapeAttr(d.image)}" alt="${escapeAttr(d.title || 'Image produit')}">` : ""}
            <div class="row">
              <h1>${escapeHtml(d.title || "")}</h1>
              ${discount ? `<span class="badge">${discount}</span>` : ""}
            </div>
            <div class="price">
              <span>${priceCurrent}</span>
              ${priceOriginal ? `<span class="old">${priceOriginal}</span>` : ""}
            </div>
            ${couponHTML}
            <p>${escapeHtml(d.desc_ai || d.desc_rcz || "")}</p>
            ${d.url ? `<a class="cta" href="${escapeAttr(d.url)}" target="_blank" rel="noopener noreferrer">Voir sur RCZ →</a>` : ""}
          `;
        } catch (err) {
          document.getElementById("deal").textContent = `❌ ${err.message}`;
        }
      }

      function copyCoupon() {
        const el = document.getElementById("coupon-code");
        if (!el) return;
        const text = el.textContent.trim();
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text);
        } else {
          // fallback
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand("copy"); alert("Code promo copié !"); } catch (e) {}
          document.body.removeChild(ta);
        }
      }

      // Utilitaires d'échappement
      function escapeHtml(s) {
        if (s == null) return "";
        return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
      }
      function escapeAttr(s) {
        return escapeHtml(s).replace(/"/g, "&quot;");
      }
    </script>
  </body>
</html>
